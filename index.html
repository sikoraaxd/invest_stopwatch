<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Денежный секундомер</title>
  <style>
    :root{
      /* Discord-like */
      --bg:#1e1f22; --panel:#2b2d31; --panel-2:#232428;
      --text:#f2f3f5; --muted:#b9bbbe; --accent:#5865F2; --ok:#3ba55c; --danger:#ED4245;
      --radius:16px; --shadow:0 10px 30px rgba(0,0,0,.45);
    }
    html,body{height:100%}
    body{margin:0; background:radial-gradient(1200px 800px at 10% -10%, #2b2d31 0%, var(--bg) 55%); color:var(--text); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Helvetica Neue,Arial; display:grid; place-items:center; padding:24px}
    .app{width:min(1050px,100%)}
    .grid{display:grid; grid-template-columns:1.2fr 1fr; gap:24px}
    @media (max-width:900px){.grid{grid-template-columns:1fr}}
    .card{background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%); border-radius:var(--radius); box-shadow:var(--shadow); padding:20px; border:1px solid rgba(255,255,255,.06)}
    .title{font-size:clamp(18px,2.2vw,22px); letter-spacing:.3px; color:var(--muted); margin:0 0 12px}
    .big{font-variant-numeric:tabular-nums; font-size:clamp(38px,7vw,64px); line-height:1.1; font-weight:800; letter-spacing:.5px}
    .currency{opacity:.9; font-weight:700; margin-left:.15em}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    @media (max-width:540px){.row{grid-template-columns:1fr}}
    label{display:block; font-size:13px; color:var(--muted); margin-bottom:6px}
    .input{width:100%; box-sizing:border-box; background:#1f2126; border:1px solid rgba(255,255,255,.08); color:var(--text); padding:12px 14px; border-radius:12px; outline:none; font-size:16px}
    .input:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(88,101,242,.15)}
    .btns{display:flex; gap:10px; flex-wrap:wrap}
    button{cursor:pointer; border:none; padding:12px 16px; border-radius:12px; font-weight:700; letter-spacing:.2px}
    .primary{background:linear-gradient(180deg,#6a75ff,var(--accent)); color:white}
    .ghost{background:transparent; color:var(--text); border:1px solid rgba(255,255,255,.14)}
    .danger{background:linear-gradient(180deg,#ff6666,var(--danger)); color:white}
    .muted{color:var(--muted); font-size:14px}
    .stats{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:16px}
    @media (max-width:600px){.stats{grid-template-columns:1fr}}
    .stat{background:rgba(255,255,255,.03); padding:12px; border-radius:12px; border:1px solid rgba(255,255,255,.06)}
    .stat .k{color:var(--muted); font-size:12px}
    .stat .v{font-variant-numeric:tabular-nums; font-weight:700}
    .eta{margin-top:10px; display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    @media (max-width:700px){.eta{grid-template-columns:1fr}}
    .eta .it{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px 12px}
    .eta .it .lbl{font-size:12px; color:var(--muted)}
    .eta .it .val{font-variant-numeric:tabular-nums; font-weight:700}
    .payout{display:grid; grid-template-columns:repeat(3,1fr); gap:12px; margin-top:6px}
    @media (max-width:700px){.payout{grid-template-columns:1fr}}
    .payout .item{background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:12px}
    .payout .item .lbl{font-size:12px; color:var(--muted)}
    .payout .item .val{font-variant-numeric:tabular-nums; font-weight:700}
    .foot{margin-top:10px; font-size:12px; color:var(--muted)}
    .chip{display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05); font-size:12px}
    .chip .dot{width:8px; height:8px; border-radius:50%; background:var(--ok); box-shadow:0 0 12px rgba(59,165,92,.7)}
    .chip.paused .dot{background:var(--danger); box-shadow:0 0 12px rgba(237,66,69,.6)}
    @keyframes pulseDot{0%{transform:scale(1);opacity:.85}50%{transform:scale(1.25);opacity:1}100%{transform:scale(1);opacity:.85}}
    .chip:not(.paused) .dot{animation:pulseDot 1.2s ease-in-out infinite}

    /* Toggle switch */
    .switch{position:relative; display:inline-block; width:52px; height:30px; flex:0 0 auto}
    .switch input{opacity:0; width:0; height:0}
    .slider{position:absolute; cursor:pointer; inset:0; background:#1f2126; border:1px solid rgba(255,255,255,.14); transition:.2s; border-radius:999px; box-shadow:inset 0 0 0 0 rgba(88,101,242,.0)}
    .slider:before{content:""; position:absolute; height:22px; width:22px; left:4px; top:3px; background:#fff; border-radius:50%; transition:.2s}
    .switch input:checked + .slider{background:linear-gradient(180deg,#6a75ff,var(--accent)); border-color:transparent; box-shadow:inset 0 0 0 2px rgba(0,0,0,.1)}
    .switch input:checked + .slider:before{transform:translateX(22px)}
  </style>
</head>
<body>
  <div class="app">
    <div class="grid">
      <section class="card" aria-live="polite">
        <p class="title">Всего начислено с запуска</p>
        <div class="big" id="earnedWrap"><span id="earnedDisplay">0,00</span><span class="currency">₽</span></div>
        <div class="stats">
          <div class="stat"><div class="k">Скорость в секунду</div><div class="v" id="perSec">—</div></div>
          <div class="stat"><div class="k">Скорость в час / день</div><div class="v" id="perHourDay">—</div></div>
        </div>
        <p class="title" style="margin-top:12px">Доход при текущих настройках</p>
        <div class="payout">
          <div class="item"><div class="lbl">В день</div><div class="val" id="outPerDay">—</div></div>
          <div class="item" id="outPerMonthWrap"><div class="lbl">В месяц (30 дн.)</div><div class="val" id="outPerMonth">—</div></div>
          <div class="item" id="outPerYearWrap"><div class="lbl">В год</div><div class="val" id="outPerYear">—</div></div>
        </div>
        <div class="eta" style="margin-top:14px">
          <div class="it"><div class="lbl">До +1 ₽</div><div class="val" id="eta1">—</div></div>
          <div class="it"><div class="lbl">До +100 ₽</div><div class="val" id="eta100">—</div></div>
          <div class="it"><div class="lbl">До +1000 ₽</div><div class="val" id="eta1000">—</div></div>
          <div class="it"><div class="lbl">До +100 000 ₽</div><div class="val" id="eta100k">—</div></div>
          <div class="it"><div class="lbl">До +1 000 000 ₽</div><div class="val" id="eta1m">—</div></div>
          <div class="it"><div class="lbl">До +10 000 000 ₽</div><div class="val" id="eta10m">—</div></div>
        </div>
        <div class="foot">
          <span id="runChip" class="chip"><span class="dot"></span><span id="runText">Идёт</span></span>
          <span style="margin-left:10px" id="dirtyFlag" class="muted" hidden>Есть несохранённые изменения — нажмите «Применить».</span>
        </div>
      </section>

      <section class="card">
        <p class="title">Настройки начисления (простые проценты)</p>
        <div class="row">
          <div>
            <label for="capital">Капитал, ₽</label>
            <input class="input" id="capital" type="number" inputmode="decimal" min="0" step="0.01" value="0" />
          </div>
          <div>
            <label for="apr">Ставка, % годовых</label>
            <input class="input" id="apr" type="number" inputmode="decimal" min="0" step="0.0001" value="0" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <div>
            <label for="basis">Годовая база</label>
            <select id="basis" class="input">
              <option value="365" selected>365 дней</option>
              <option value="366">366 (високосный)</option>
              <option value="360">360 (банковская)</option>
            </select>
          </div>
          <div>
            <label for="precision">Точность отображения</label>
            <select id="precision" class="input">
              <option value="2" selected>2 знака</option>
              <option value="4">4 знака</option>
              <option value="6">6 знаков</option>
            </select>
          </div>
        </div>

        <!-- Реинвестирование: учитывать доход в капитале -->
        <div class="row" style="margin-top:12px">
          <div style="grid-column:1 / -1; display:flex; align-items:center; justify-content:space-between; gap:12px">
            <label for="includeIncome" style="margin:0">
              Учитывать доход (реинвестировать)
              <div class="muted">При включении капитал растёт за счёт прибыли</div>
            </label>
            <label class="switch">
              <input id="includeIncome" type="checkbox" />
              <span class="slider" aria-hidden="true"></span>
            </label>
          </div>
        </div>

        <div class="btns" style="margin-top:16px">
          <button id="apply" class="primary">Применить</button>
          <button id="pause" class="ghost">Пауза</button>
          <button id="reset" class="danger" title="Сбросить накопленную сумму в ноль">Сброс</button>
        </div>
        <p class="muted" style="margin-top:10px">Изменения ставки/капитала вступают в силу после «Применить». Накопленная сумма <strong>не сбрасывается</strong>.</p>
      </section>
    </div>
  </div>

  <script>
    // ---------- Favicon c эмодзи 💸 ----------
    (function(){
      var emoji = '💸';
      var svg = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><text y="50" font-size="50">' + emoji + '</text></svg>';
      var url = 'data:image/svg+xml,' + encodeURIComponent(svg);
      var link = document.querySelector("link[rel='icon']");
      if (!link) { link = document.createElement('link'); link.rel = 'icon'; document.head.appendChild(link); }
      link.href = url;
    })();

    // ---------- Логика секундомера ----------
    var els = {
      earned: document.getElementById('earnedDisplay'),
      perSec: document.getElementById('perSec'),
      perHourDay: document.getElementById('perHourDay'),
      outPerDay: document.getElementById('outPerDay'),
      outPerMonth: document.getElementById('outPerMonth'),
      outPerYear: document.getElementById('outPerYear'),
      outPerMonthWrap: document.getElementById('outPerMonthWrap'),
      outPerYearWrap: document.getElementById('outPerYearWrap'),
      eta1: document.getElementById('eta1'),
      eta100: document.getElementById('eta100'),
      eta1000: document.getElementById('eta1000'),
      eta100k: document.getElementById('eta100k'),
      eta1m: document.getElementById('eta1m'),
      eta10m: document.getElementById('eta10m'),
      runChip: document.getElementById('runChip'),
      runText: document.getElementById('runText'),
      dirtyFlag: document.getElementById('dirtyFlag'),
      cap: document.getElementById('capital'),
      apr: document.getElementById('apr'),
      basis: document.getElementById('basis'),
      precision: document.getElementById('precision'),
      includeIncome: document.getElementById('includeIncome'),
      apply: document.getElementById('apply'),
      pause: document.getElementById('pause'),
      reset: document.getElementById('reset')
    };

    var capital = 0;
    var apr = 0; // %
    var basis = parseInt(els.basis.value, 10) || 365; // дней в году
    var running = true;
    var last = performance.now(); // ms
    var acc = 0; // всего начислено с запуска (для отображения)
    var includeIncome = false; // реинвестировать доход в капитал
    var ratePerSec = 0; // вычисляется на лету

    function computePerSec(cap, aprPct, basisDays){
      var r = Math.max(0, aprPct) / 100;
      var secondsInYear = basisDays * 24 * 3600;
      return Math.max(0, cap) * r / secondsInYear;
    }

    function readNumber(el){
      var v = el.valueAsNumber;
      if (Number.isFinite(v)) return v;
      var s = String(el.value || '').split(' ').join(''); // убираем пробелы
      s = s.replace(',', '.');
      var n = parseFloat(s);
      return Number.isFinite(n) ? n : 0;
    }

    function formatShort(n, f){ if (f===undefined) f=2; return new Intl.NumberFormat('ru-RU',{minimumFractionDigits:f, maximumFractionDigits:f}).format(n); }
    function formatRate(n, f){ if (f===undefined) f=6; return new Intl.NumberFormat('ru-RU',{minimumFractionDigits:f, maximumFractionDigits:f}).format(n) + ' ₽/с'; }
    function formatDuration(totalSeconds){
      if (!isFinite(totalSeconds)) return '—';
      if (totalSeconds < 0) totalSeconds = 0;
      var s = Math.floor(totalSeconds);
      var days = Math.floor(s / 86400);
      var r1 = s % 86400;
      var hh = Math.floor(r1 / 3600);
      var r2 = r1 % 3600;
      var mm = Math.floor(r2 / 60);
      var ss = r2 % 60;
      var pad = function(n){ return String(n).padStart(2,'0'); };
      return (days>0? (days + 'д ') : '') + pad(hh) + ':' + pad(mm) + ':' + pad(ss);
    }

    // -------- Обновление «скоростей/выплат» от текущей ratePerSec (лёгкое, вызываем каждый кадр)
    function updateStatsLive(){
      var frac = parseInt(els.precision.value, 10) || 2;
      var r = ratePerSec;
      els.perSec.textContent = formatRate(r, Math.min(frac, 8));
      var perHour = r * 3600;
      var perDay  = r * 86400;
      var perMonth = perDay * 30;               // 30-дневный месяц
      var perYear  = r * basis * 86400;         // эквивалентно capital * apr/100
      els.perHourDay.textContent = formatShort(perHour, frac) + ' ₽/ч · ' + formatShort(perDay, frac) + ' ₽/д';
      els.outPerDay.textContent = formatShort(perDay, frac) + ' ₽';
      if (perMonth > 0){ els.outPerMonthWrap.style.display = ''; els.outPerMonth.textContent = formatShort(perMonth, frac) + ' ₽'; }
      else { els.outPerMonthWrap.style.display = 'none'; }
      if (perYear > 0){ els.outPerYearWrap.style.display = ''; els.outPerYear.textContent = formatShort(perYear, frac) + ' ₽'; }
      else { els.outPerYearWrap.style.display = 'none'; }
    }

    function updateETAs(){
      var steps = [1, 100, 1000, 100000, 1000000, 10000000];
      var elsArr = [els.eta1, els.eta100, els.eta1000, els.eta100k, els.eta1m, els.eta10m];
      var currentRps = ratePerSec;
      if (currentRps <= 0){
        for (var j=0;j<elsArr.length;j++){ if (elsArr[j]) elsArr[j].textContent = '—'; }
        return;
      }
      for (var i=0;i<steps.length;i++){
        var el = elsArr[i]; if (!el) continue;
        var step = steps[i];
        var progress = acc % step; if (progress < 0) progress += step;
        var eps = step * 1e-9;
        var remainAmount = step - progress;
        if (remainAmount <= eps) remainAmount = step;
        var remain = remainAmount / currentRps;
        if (!isFinite(remain) || remain < 0) remain = 0;
        el.textContent = formatDuration(remain);
      }
    }

    // Полный пересчёт (используем при изменении настроек, а не каждый кадр)
    function updateDerived(){
      ratePerSec = computePerSec(capital, apr, basis);
      updateStatsLive();
      updateETAs();
    }

    function render(){
      var frac = parseInt(els.precision.value, 10) || 2;
      els.earned.textContent = formatShort(acc, frac);
      updateETAs();
    }

    function accrue(dt, r){
      if (dt <= 0) return;
      var income = dt * r;
      acc += income;                 // всегда наращиваем «Всего начислено»
      if (includeIncome){
        capital += income;           // и капитал, если включён реинвест
        els.cap.value = capital.toFixed(2);
      }
    }

    function finalizeAcc(){
      var now = performance.now();
      if (running){
        var dt = (now - last) / 1000;
        // доход за прошедшее время по ставке ДО начисления
        var r0 = computePerSec(capital, apr, basis);
        accrue(dt, r0);
      }
      last = now;
      // пересчёт актуальной скорости после возможного роста капитала
      ratePerSec = computePerSec(capital, apr, basis);
      updateStatsLive();
    }

    function applySettings(){
      finalizeAcc(); // фиксируем доход по старой скорости
      capital = readNumber(els.cap);
      apr = readNumber(els.apr);
      basis = parseInt(els.basis.value, 10) || 365;
      updateDerived();
      els.dirtyFlag.hidden = true;
    }

    // Инициализация
    updateDerived();
    render();
    requestAnimationFrame(function(t){ last = t; requestAnimationFrame(loop); });

    function loop(ts){
      if (running){
        var dt = (ts - last) / 1000;

        // 1) считаем доход по скорости до начисления (r0)
        var r0 = computePerSec(capital, apr, basis);
        accrue(dt, r0);

        // 2) капитал мог увеличиться — пересчитываем скорость (r1)
        ratePerSec = computePerSec(capital, apr, basis);

        last = ts;

        // 3) обновляем «в секунду/час/день» и «выплаты» каждый кадр
        updateStatsLive();

        // 4) перерисовываем сумму и ETA
        render();
      } else {
        last = ts;
      }
      requestAnimationFrame(loop);
    }

    // Слушатели
    [els.cap, els.apr, els.basis].forEach(function(inp){
      inp.addEventListener('input', function(){ els.dirtyFlag.hidden = false; });
    });
    els.precision.addEventListener('change', function(){ updateDerived(); render(); });
    els.apply.addEventListener('click', applySettings);
    els.pause.addEventListener('click', function(){
      finalizeAcc();
      running = !running;
      els.pause.textContent = running ? 'Пауза' : 'Продолжить';
      els.runText.textContent = running ? 'Идёт' : 'На паузе';
      els.runChip.classList.toggle('paused', !running);
      last = performance.now();
    });
    els.reset.addEventListener('click', function(){
      if (!confirm('Сбросить накопленную сумму в ноль?')) return;
      finalizeAcc(); acc = 0; updateDerived(); render();
    });

    // ВКЛ/ВЫКЛ реинвестирования
    els.includeIncome.addEventListener('change', function(){
      finalizeAcc(); // досчитать всё до момента переключения
      var wasOn = includeIncome;
      includeIncome = !!els.includeIncome.checked;

      // Если только что ВКЛ — единовременно докинем «уже заработанное» в капитал
      if (!wasOn && includeIncome){
        capital += acc;
        els.cap.value = capital.toFixed(2);
      }
      updateDerived(); // скорость и выводы пересчитать тут же
      render();
    });

    // -------- Mini self-tests (не мешают работе) --------
    (function(){
      try {
        var rps = computePerSec(35000, 17.33, 365);
        var perDay = rps * 86400;
        console.assert(Math.abs(perDay - 16.6178) < 0.1, 'perDay≈16.62');
        console.assert(formatDuration(0) === '00:00:00', 'formatDuration zero');
      } catch(e) { console.warn('Self-tests skipped', e); }
    })();
  </script>
</body>
</html>
